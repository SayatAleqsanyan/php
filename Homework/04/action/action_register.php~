<?php
session_start();

if (isset($_POST['login'])
    && !empty($_POST['First_Name'])
    && !empty($_POST['Last_Name'])
    && !empty($_POST['Date_of_Birth'])
    && !empty($_POST['Country'])
    && !empty($_POST['gender'])
    && !empty($_POST['password'])
    && !empty($_POST['email'])
) {
    $email = $_POST["email"];
    $password = $_POST["password"];
    $hashed_password = password_hash($password, PASSWORD_DEFAULT);

    $line = $email . '|' . $hashed_password . '|' . $_POST['First_Name'] . '|' . $_POST['Last_Name'] . '|' .
        $_POST['Date_of_Birth'] . '|' . $_POST['Country'] . '|' . $_POST['gender'] . "\n";

    // Ստուգում ենք կրկնվող email
    if (file_exists('../data/users.txt')) {
        $users = file('../data/users.txt', FILE_IGNORE_NEW_LINES);
        foreach ($users as $user) {
            $data = explode('|', $user);
            if ($data[0] == $email) {
                $_SESSION['error'] = "Email already registered.";
                header("Location: ../index.php?mode=register");
                exit();
            }
        }
    }

    // Գրանցում ենք
    file_put_contents('../data/users.txt', $line, FILE_APPEND);

    // Սկսում ենք session
    $_SESSION['email'] = $email;
    $_SESSION['First_Name'] = $_POST['First_Name'];
    $_SESSION['Last_Name'] = $_POST['Last_Name'];
    $_SESSION['Date_of_Birth'] = $_POST['Date_of_Birth'];
    $_SESSION['Country'] = $_POST['Country'];
    $_SESSION['gender'] = $_POST['gender'];

    header("Location: ../pages/home.php");
} else {
    $_SESSION['error'] = "All fields are required.";
    header("Location: ../index.php?mode=register");
}
